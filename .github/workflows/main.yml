name: DhruvWilsonRDP â€“ Fixed Version

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth Key"
        required: true
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create User and Directories
        run: |
          $sec = ConvertTo-SecureString "Rdp!9Xq#2025" -AsPlainText -Force
          $username = "DhruvWilson"
          
          # Create user if doesn't exist
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Write-Host "User $username created"
          }
          
          # Create directories
          New-Item -Path "C:\Users\$username\Desktop" -ItemType Directory -Force
          New-Item -Path "C:\Users\$username\Downloads" -ItemType Directory -Force
          New-Item -Path "C:\PersistentData" -ItemType Directory -Force
          New-Item -Path "C:\Users\$username\AppData\Local\Google\Chrome\User Data" -ItemType Directory -Force
          
          Write-Host "Directories created"

      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            C:\Users\DhruvWilson\AppData\Local\Google\Chrome\User Data
            C:\Users\DhruvWilson\Downloads
            C:\PersistentData
          key: rdp-v4-${{ github.run_id }}
          restore-keys: |
            rdp-v4-

      - name: Install Tailscale
        run: |
          Write-Host "Downloading Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $output = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $output
          
          Write-Host "Installing Tailscale..."
          Start-Process msiexec.exe -Wait -ArgumentList "/i", "`"$output`"", "/quiet", "/norestart"
          
          # Wait for installation to complete
          Start-Sleep -Seconds 10
          
          Write-Host "Connecting to Tailscale..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ inputs.ts_authkey }}" --hostname "DhruvWilsonRDP"
          
          # Get IP
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "Tailscale IP: $ip"

      - name: Enable RDP
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          # Enable firewall rule
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Set user password never expires
          $username = "DhruvWilson"
          Set-LocalUser -Name $username -PasswordNeverExpires $true
          
          Write-Host "RDP Enabled"

      - name: Show Connection Info
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
          if (-not $ip) {
            $ip = "Waiting for Tailscale IP..."
          }
          
          Write-Host "=================================================="
          Write-Host "    RDP CONNECTION DETAILS"
          Write-Host "=================================================="
          Write-Host "IP Address  : $ip"
          Write-Host "Username    : DhruvWilson"
          Write-Host "Password    : Rdp!9Xq#2025"
          Write-Host "=================================================="
          Write-Host "Session will run for 6 hours"
          Write-Host "Cancel job to save data"
          Write-Host "=================================================="

      - name: Keep Session Alive
        shell: powershell
        run: |
          $endTime = (Get-Date).AddHours(6)
          
          while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $hours = $remaining.Hours
            $minutes = $remaining.Minutes
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active - Time remaining: $hours hours $minutes minutes"
            
            # Test Tailscale connection
            $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
            if ($ip) {
              Write-Host "Tailscale IP: $ip"
            }
            
            Start-Sleep -Seconds 60  # Check every minute
          }

      - name: Save Cache Always
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            C:\Users\DhruvWilson\AppData\Local\Google\Chrome\User Data
            C:\Users\DhruvWilson\Downloads
            C:\PersistentData
          key: rdp-v4-${{ github.run_id }}-${{ github.run_attempt }}
